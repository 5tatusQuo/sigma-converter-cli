trigger:
  branches:
    include:
    - main
    - dev

pool:
  vmImage: 'ubuntu-latest'

variables:
  python.version: '3.11'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildJob
    displayName: 'Install and Validate Sigma CLI'
    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(python.version)'
      inputs:
        versionSpec: '$(python.version)'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install dependencies'

    - script: |
        python convert.py example_rule.yml
      displayName: 'Test conversion with example rule'
      condition: succeeded()

- stage: ConvertRules
  displayName: 'Convert Sigma Rules and Create PR'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: ConvertJob
    displayName: 'Convert Sigma Rules to Kusto'
    steps:
    - checkout: self
      persistCredentials: true
      displayName: 'Checkout with persisted credentials'

    - task: UsePythonVersion@0
      displayName: 'Use Python $(python.version)'
      inputs:
        versionSpec: '$(python.version)'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install dependencies'

    - script: |
        python convert.py rules/ -o converted_rules/
      displayName: 'Convert folder of Sigma rules to KQL'
      workingDirectory: $(System.DefaultWorkingDirectory)
      condition: and(succeeded(), exists('rules'))

    - task: PublishBuildArtifacts@1
      displayName: 'Publish converted rules'
      inputs:
        PathtoPublish: 'converted_rules'
        ArtifactName: 'kusto-queries'
        publishLocation: 'Container'
      condition: succeededOrFailed()

    # Configure git and create branch
    - script: |
        git config user.email "azure-devops@pipeline.com"
        git config user.name "Azure DevOps Pipeline"

        BRANCH_NAME="automated-kql-conversion-$(date +%Y%m%d-%H%M%S)"
        echo "##vso[task.setvariable variable=branchName]$BRANCH_NAME"

        git checkout -b $BRANCH_NAME
      displayName: 'Configure git and create branch'

    # Commit and push changes
    - script: |
        # Force add converted_rules even though it's in .gitignore
        git add -f converted_rules/

        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "##vso[task.setvariable variable=hasChanges]false"
        else
          git commit -m "Automated KQL conversion from Sigma rules

          This is an automated commit generated by the Azure DevOps pipeline.

          Converted Sigma rules to Kusto Query Language (KQL) format."

          git push origin $(branchName)
          echo "##vso[task.setvariable variable=hasChanges]true"
        fi
      displayName: 'Commit and push converted rules'
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

    # Create Pull Request
    - task: PowerShell@2
      displayName: 'Create Pull Request'
      condition: and(succeeded(), eq(variables['hasChanges'], 'true'))
      inputs:
        targetType: 'inline'
        script: |
          $url = "$(System.CollectionUri)$(System.TeamProject)/_apis/git/repositories/$(Build.Repository.Name)/pullrequests?api-version=7.0"

          $body = @{
            sourceRefName = "refs/heads/$(branchName)"
            targetRefName = "refs/heads/$(Build.SourceBranchName)"
            title = "Automated KQL Conversion - $(Build.BuildNumber)"
            description = "This PR contains automatically converted Kusto Query Language (KQL) files from Sigma rules.`n`n**Build:** [$(Build.BuildNumber)]($(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId))`n`n**Source Branch:** $(Build.SourceBranchName)`n**Target Branch:** $(branchName)`n`nGenerated by Azure DevOps Pipeline."
          } | ConvertTo-Json

          $headers = @{
            Authorization = "Bearer $(System.AccessToken)"
            "Content-Type" = "application/json"
          }

          try {
            $response = Invoke-RestMethod -Uri $url -Method Post -Headers $headers -Body $body
            Write-Host "Pull request created successfully!"
            Write-Host "PR ID: $($response.pullRequestId)"
            Write-Host "PR URL: $($response.url)"
          } catch {
            Write-Host "##vso[task.logissue type=error]Failed to create pull request: $_"
            exit 1
          }
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
